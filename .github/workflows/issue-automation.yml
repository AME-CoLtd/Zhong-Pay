name: ğŸ¤– Issue è‡ªåŠ¨åŒ–å¤„ç†

on:
  issues:
    types: [opened, labeled, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  # ============================================================
  # æ–° Issue è‡ªåŠ¨å›å¤ + æ ‡ç­¾åˆ†é…
  # ============================================================
  auto-triage:
    name: è‡ªåŠ¨åˆ†ç±» & å›å¤
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    permissions:
      issues: write

    steps:
      - name: è¯»å– Issue ä¿¡æ¯
        id: issue-info
        run: |
          LABELS='${{ toJson(github.event.issue.labels.*.name) }}'
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT

      # ---- Bug æŠ¥å‘Šè‡ªåŠ¨å›å¤ ----
      - name: å›å¤ Bug æŠ¥å‘Š
        if: contains(github.event.issue.labels.*.name, 'bug')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ‘‹ æ„Ÿè°¢ä½ çš„ Bug æŠ¥å‘Šï¼

            ä½ å¥½ @${{ github.event.issue.user.login }}ï¼Œæ„Ÿè°¢ä½ èŠ±æ—¶é—´åé¦ˆè¿™ä¸ªé—®é¢˜ï¼

            **æˆ‘ä»¬å·²æ”¶åˆ°ä½ çš„æŠ¥å‘Š**ï¼Œç»´æŠ¤å›¢é˜Ÿï¼ˆAMEï¼‰å°†å°½å¿«æ ¸æŸ¥å¹¶å¤„ç†ã€‚

            åœ¨æ­¤æœŸé—´ï¼Œä½ å¯ä»¥ï¼š
            - ğŸ“– æŸ¥é˜… [FAQ æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/docs/faq.md) çœ‹æ˜¯å¦æœ‰è§£å†³æ–¹æ¡ˆ
            - ğŸ” æŸ¥çœ‹ [åŒç±» Issues](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+label%3Abug) æ˜¯å¦æœ‰ç›¸å…³è®¨è®º
            - ğŸ’¬ å‰å¾€ [Discussions](https://github.com/${{ github.repository }}/discussions) ä¸ç¤¾åŒºäº¤æµ

            > å¦‚éœ€åŠ å¿«å¤„ç†ï¼Œè¯·ç¡®ä¿å·²æä¾›å®Œæ•´çš„**å¤ç°æ­¥éª¤**å’Œ**é”™è¯¯æ—¥å¿—**ã€‚
            
            ---
            *æœ¬å›å¤ç”± AME è‡ªåŠ¨åŒ–ç³»ç»Ÿå‘é€*`
            })

      # ---- åŠŸèƒ½å»ºè®®è‡ªåŠ¨å›å¤ ----
      - name: å›å¤åŠŸèƒ½å»ºè®®
        if: contains(github.event.issue.labels.*.name, 'enhancement')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ’¡ æ„Ÿè°¢ä½ çš„åŠŸèƒ½å»ºè®®ï¼

            ä½ å¥½ @${{ github.event.issue.user.login }}ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†ä½ çš„åŠŸèƒ½å»ºè®®ï¼

            **æ¥ä¸‹æ¥çš„æµç¨‹ï¼š**
            1. ğŸ“‹ ç»´æŠ¤å›¢é˜Ÿï¼ˆAMEï¼‰å°†è¯„ä¼°å¯è¡Œæ€§å’Œä¼˜å…ˆçº§
            2. ğŸ’¬ å¯èƒ½ä¼šåœ¨æ­¤ Issue ä¸‹è¿›è¡Œè®¨è®ºï¼Œæ¬¢è¿å‚ä¸
            3. ğŸš€ é€šè¿‡è¯„å®¡åä¼šè¿›å…¥å¼€å‘è®¡åˆ’

            **æƒ³åŠ é€Ÿè¿™ä¸ªåŠŸèƒ½çš„å®ç°ï¼Ÿ**
            - ğŸ‘ ç‚¹èµæ­¤ Issue å¢åŠ ä¼˜å…ˆçº§æƒé‡
            - ğŸ”§ æ¬¢è¿ç›´æ¥æäº¤ PR å®ç°ï¼Œå‚è€ƒ [è´¡çŒ®æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)

            ---
            *æœ¬å›å¤ç”± AME è‡ªåŠ¨åŒ–ç³»ç»Ÿå‘é€*`
            })

      # ---- ä½¿ç”¨ç–‘é—®è‡ªåŠ¨å›å¤ ----
      - name: å›å¤ä½¿ç”¨ç–‘é—®
        if: contains(github.event.issue.labels.*.name, 'question')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ™‹ ä½ å¥½ï¼æˆ‘ä»¬æ¥å¸®ä½ è§£å†³é—®é¢˜

            ä½ å¥½ @${{ github.event.issue.user.login }}ï¼Œæ„Ÿè°¢ä½ ä½¿ç”¨ä¼—æ”¯ä»˜ï¼

            **åœ¨ç­‰å¾…å›å¤æœŸé—´ï¼Œä»¥ä¸‹èµ„æºå¯èƒ½å¸®åŠ©ä½ å¿«é€Ÿè§£å†³é—®é¢˜ï¼š**

            | èµ„æº | é“¾æ¥ |
            |------|------|
            | ğŸ“– FAQ å¸¸è§é—®é¢˜ | [docs/faq.md](https://github.com/${{ github.repository }}/blob/main/docs/faq.md) |
            | ğŸ³ Docker éƒ¨ç½²æŒ‡å— | [docs/deploy-docker.md](https://github.com/${{ github.repository }}/blob/main/docs/deploy-docker.md) |
            | â–² Vercel éƒ¨ç½²æŒ‡å— | [docs/deploy-vercel.md](https://github.com/${{ github.repository }}/blob/main/docs/deploy-vercel.md) |
            | â˜ï¸ Cloudflare éƒ¨ç½²æŒ‡å— | [docs/deploy-cloudflare.md](https://github.com/${{ github.repository }}/blob/main/docs/deploy-cloudflare.md) |
            | ğŸ”Œ API æ–‡æ¡£ | [docs/api.md](https://github.com/${{ github.repository }}/blob/main/docs/api.md) |
            | ğŸ’¬ ç¤¾åŒºè®¨è®º | [GitHub Discussions](https://github.com/${{ github.repository }}/discussions) |

            ç»´æŠ¤å›¢é˜Ÿï¼ˆAMEï¼‰ä¼šå°½å¿«å›å¤ï¼

            ---
            *æœ¬å›å¤ç”± AME è‡ªåŠ¨åŒ–ç³»ç»Ÿå‘é€*`
            })

  # ============================================================
  # Issue å…³é—­æ—¶è‡ªåŠ¨æ„Ÿè°¢
  # ============================================================
  auto-close-thanks:
    name: å…³é—­æ—¶è‡´è°¢
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    permissions:
      issues: write

    steps:
      - name: å‘é€æ„Ÿè°¢è¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            // åªå¯¹é wontfix / duplicate / invalid çš„å…³é—­å‘é€æ„Ÿè°¢
            const labels = context.payload.issue.labels.map(l => l.name);
            const skipLabels = ['wontfix', 'duplicate', 'invalid'];
            if (skipLabels.some(l => labels.includes(l))) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âœ… æ­¤ Issue å·²å…³é—­

            æ„Ÿè°¢ @${{ github.event.issue.user.login }} çš„åé¦ˆï¼Œä»¥åŠå‚ä¸è®¨è®ºçš„æ‰€æœ‰äººï¼

            å¦‚æœé—®é¢˜**ä»æœªè§£å†³**ï¼Œæ¬¢è¿ï¼š
            - ğŸ’¬ ç»§ç»­åœ¨æ­¤ Issue ä¸‹è¯„è®º
            - ğŸ”„ é‡æ–°æ‰“å¼€æ­¤ Issueï¼ˆé™„ä¸Šæ›´å¤šä¿¡æ¯ï¼‰
            - ğŸ“– æŸ¥é˜… [FAQ æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/docs/faq.md)

            æ„Ÿè°¢æ”¯æŒä¼—æ”¯ä»˜ â­ â€” **AME**`
            })

  # ============================================================
  # è‡ªåŠ¨ç»™ 30 å¤©æ— æ´»åŠ¨çš„ Issue æ·»åŠ  stale æ ‡ç­¾
  # ============================================================
  stale-issues:
    name: è¿‡æœŸ Issue æ¸…ç†
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      issues: write

    steps:
      - uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: |
            ğŸ‘‹ æ­¤ Issue å·²è¶…è¿‡ 30 å¤©æ²¡æœ‰æ´»åŠ¨ã€‚
            
            å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·å›å¤æ­¤è¯„è®ºæˆ–æä¾›æ›´å¤šä¿¡æ¯ï¼Œæˆ‘ä»¬ä¼šç»§ç»­è·Ÿè¿›ã€‚
            å¦åˆ™ï¼Œæ­¤ Issue å°†åœ¨ 7 å¤©åè‡ªåŠ¨å…³é—­ã€‚
            
            â€” AME è‡ªåŠ¨åŒ–ç³»ç»Ÿ
          close-issue-message: |
            ç”±äºé•¿æ—¶é—´æ— æ´»åŠ¨ï¼Œæ­¤ Issue å·²è‡ªåŠ¨å…³é—­ã€‚
            å¦‚é—®é¢˜ä»å­˜åœ¨ï¼Œæ¬¢è¿é‡æ–°å¼€å¯æˆ–æäº¤æ–° Issueã€‚
          stale-issue-label: "stale"
          days-before-stale: 30
          days-before-close: 7
          exempt-issue-labels: "pinned,security,in-progress,help wanted"
